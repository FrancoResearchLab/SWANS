# Author:	E. Reichenberger
# Date:		2.16.2021

#--------------------MESSAGES-----------------------------------
onsuccess:
  print("The  soupX pipeline completed with no errors.")
  shell("mail -s 'The soupX pipeline completed with no errors.' "+ config['contact']+" < {log}")

onerror:
  print("The  soupX pipeline did not complete without errors."),
  shell("mail -s 'The soupX pipeline did not complete without errors, check the logs and try again.' "+ config['contact']+" < {log}")

#--------------------RULES---------------------------------------
rule soupX:
	input:
		script = 'src/scripts/soupX.R',
		cellranger_input = cellranger_output,
	params:
		r_lib_path = RPATH,
		sample = '{s}',
		project = PROJECT,
		input_type = SOUPX_START,
		soupX_input = 'data/endpoints/' + PROJECT + '/{s}/' + STARTING_DATA + '/',
		soupx_output = 'data/endpoints/' + PROJECT + '/' + '{s}/soupX/',
		starting_data = STARTING_DATA,
		sequencing_type = SEQUENCING_TYPE
	output:
		barcodes_path = 'data/endpoints/' + PROJECT + '/' + '{s}/soupX/barcodes.tsv.gz',
		features_path = 'data/endpoints/' + PROJECT + '/' + '{s}/soupX/features.tsv.gz',
		matrix_path = 'data/endpoints/' + PROJECT + '/' + '{s}/soupX/matrix.mtx.gz',
	log:
		log_output = soupX_log  + PROJECT + '_{s}_soupX.log'
	benchmark: benchmark_log + PROJECT.lower() + '_{s}_soupX.benchmark'
	shell:
		"Rscript {input.script} \
		--sample {params.sample} \
		--data_type {params.input_type} \
		--project {params.project} \
		--soupX_input_path {params.soupX_input} \
		--soupX_output_path  {params.soupx_output} \
		--sequencing_type {params.sequencing_type} \
		--starter_data {params.starting_data} \
		{params.r_lib_path} 2> {log.log_output}"
